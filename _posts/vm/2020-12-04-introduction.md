---
title: Hello From Azure Virtual Machine!
index: 10
layout: post
date: 2020-12-04 12:00
categories: 
    - Azure CLI
    - Azure Virtual Machine
permalink: azure-cli/vm/introduction
tags:
    - devops
    - vm
description: Azure allows you to create Virtual Machines with all the necessary resources provisioned. This tutorial shows how you can create a Virtual Machine with just a single CLI call, then go deeper into the auto-provisioned resources. 
---

## **Introduction**

{{page.description}}
{%include az-cli/000-prerequisites.md%}

## **Prepare**
{%include az-cli/005-login-account.md%}
{% include az-cli/010-create-resource-group.md %}

## **Create VM**

1. Create the virtual machine

    ```shell
    vmname=vm-demo-linux-1
    az vm create \
        --name $vmname \
        --image "rhel" \
        --size "Standard_B1S" \
        --admin-username "demoadmin" \
        --authentication-type "ssh" \
        --generate-ssh-keys
    ```
    This creates a RedHat Linux virtual machine and all its dependent resources provisioned.

    On successful completion, expect response to include `"powerState": "VM Running"`.

    > The `--generate-ssh-keys` option the SSH key pairs in ~/.ssh/ from your bash session. If the key pairs do not exist, expect them to be autogenerated with confirmation message `SSH key files '/home/cloud/.ssh/id_rsa' and '/home/cloud/.ssh/id_rsa.pub' have been generated under ~/.ssh`.

1. Start an SSH session.

    ```shell
    publicIpAddress=$(az vm list-ip-addresses --name $vmname --query [0].virtualMachine.network.publicIpAddresses[0].ipAddress --output tsv)
    ssh demoadmin@$publicIpAddress
    ```
    You should be able to connect to the server via SSH session without the need of a password.

## **View Provisioned Resources**

1. List the resources in the resource group.

    ```shell
    az resource list --query "[?contains(@.name, '$vmname')==\`true\`].[name, type]" --output table
    ```

    Expect the following resources auto-generated by `az vm create`:
    * `vm-demo-linux-1` is the actual Virtual Machine created.
    * `vm-demo-linux-1VNET` is the virtual network created.
    * `vm-demo-linux-1VMNic` is the network interface card.
    * `vm-demo-linux-1NSG` is the network security group attached to the card.
    * `vm-demo-linux-1PublicIP` is the Public IP address allocated to the card.
    * `vm-demo-linux-1_OsDisk_1_{RANDOM}` is the attached storage volume created.

1. View **Virtual Machine** provisioned.

    ```shell
    az vm show --name $vmname
    ```
    From the response, expect to see the `"vmId"`, `"vmSize": "Standard_B1S"` in `"hardwareProfile"`, the Network Interface Card used in `"networkProfile"`, ssh public key upload in `"osProfile"`, the RedHat OS image and the managed disk used in `"storageProfile"`.

1. View **Os Disk** provisioned for the VM.

    ```shell
    osDiskName=$(az vm show --name $vmname --query storageProfile.osDisk.name --output tsv)
    az disk show --name $osDiskName
    ```
    From the results, expect to see `"osType": "Linux"` and auto-provisioned to `"diskSizeGb": 64` and `"tier": "P6"`.

    > Refer to [Managed Disk](https://azure.microsoft.com/en-gb/pricing/details/managed-disks/){:target="_blank"} tiers for details.

1. View **Network Interface Card** provisioned for the VM.

    ```shell
    nicId=$(az vm show --name $vmname --query networkProfile.networkInterfaces[0].id --output tsv)
    az network nic show --ids $nicId
    ```
    From the response, expect to see details `"dnsSettings"`, `"macAddress"`, `"virtualMachine"` attached and `"privateIpAddress"` in `"ipConfigurations"`.

    From `"ipConfigurations"`, expect to see the Public IP address allocated in `"publicIpAddress"` and linked subnet in `"subnet"`.

1. View **Network Security Group** provisioned for the Network Interface Card.

    ```shell
    nsgId=$(az network nic show --ids $nicId --query networkSecurityGroup.id --output tsv)
    az network nsg show --ids $nsgId
    ```
    From the response, expect to see the network interface attached in `"networkInterfaces"`, inbound and outbound security rules that cannot be removed in `"defaultSecurityRules"`, and auto-provisioned rule to allow inbound TCP traffic on port 22 for SSH in `"securityRules"`.

    >To view the same security rule details.
    >```
    >nsgRuleId=$(az network nsg show --ids $nsgId --query "securityRules[?destinationPortRange=='22' && protocol=='Tcp'].id" --output tsv)
    >az network nsg rule show --ids $nsgRuleId
    >```

1. View **Public IP Address** provisioned to the Network Interface Card.

    ```shell
    publicIpId=$(az network nic show --ids $nicId --query ipConfigurations[0].publicIpAddress.id --output tsv)
    az network public-ip show --ids $publicIpId
    ```
    From the response, expect to see `"ipAddress"` and `"name": "Basic"` in `"sku"`.

    >Basic SKU Public IP addresses have the following attributes:
    >* Assigned with the static or dynamic allocation method.
    >* Adjustable inbound originated flow idle timeout of 4-30 minutes, with a default of 4 minutes, and fixed outbound originated flow idle timeout of 4 minutes.
    >* Are open by default unlike Standard SKU which are closed by default.
    >* Network security groups optional for restricting inbound or outbound traffic; it is required in Standard SKU.
    >* Assignable to Azure resources including Network interfaces.
    >* Does not support Availability Zone scenarios, unlike Standard SKU.

1. View the **Ip Configuration** linking the Public Ip Address.

    ```shell
    ipConfigId=$(az network public-ip show --ids $publicIpId --query ipConfiguration.id --output tsv)
    az network nic ip-config show --ids $ipConfigId
    ```
    From the response, expect to see details of the `"subnet"` linking with the `"publicIpAddress"`.

1. View **Subnet** provisioned.

    ```shell
    subnetId=$(az network nic show --ids $nicId --query "ipConfigurations[?id=='$ipConfigId']".subnet.id --output tsv)
    az network vnet subnet show --ids $subnetId
    ```
    From the response, expect to see the CIDR block in `"addressPrefix"`, and its link to the Public Ip Address in `"ipConfigurations"`.

1. View **Virtual Network** provisioned attaching the subnet.

    ```shell
    vnetId=$(az network vnet subnet show --ids $subnetId --query id --output tsv | sed -E "s|(.+)/subnets.+|\1|g"
    az network vnet show --ids $vnetId
    ```
    From the response, expect to see the CIDR block allocations in `"addressSpace"` and the subnet attached in `"subnets"`.


## **Clean up**

{% include az-cli/999-cleanup.md %}

    >To delete VM and its resources
    >```
    ># delete vm
    >az vm delete --name $vmname
    >
    ># delete network interface card
    >az network nic delete --name "${vmname}VMNic"
    >
    ># delete network security group
    >az network nsg delete --name "${vmname}NSG"
    >
    ># delete public ip
    >az network public-ip --name "${vnname}PublicIP"
    >
    ># delete virtual network (including subnet)
    >az network vnet delete --name "${vmname}VNET"
    >
    ># delete storage volume
    >diskname=$(az resource list --query "[?type=='Microsoft.Compute/disks'].name" --output tsv)
    >az disk delete --name $diskname
    >```



https://docs.microsoft.com/en-us/azure/virtual-network/public-ip-addresses#ip-address-version